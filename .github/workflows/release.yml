name: Create Release

on:
  push:
    tags:
      - 'v*.*.*'  # Matches v1.0.0, v1.2.3, etc.

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Get pnpm store directory
        id: pnpm-cache
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path)" >> $GITHUB_OUTPUT

      - name: Setup pnpm cache
        uses: actions/cache@v4
        with:
          path: ${{ steps.pnpm-cache.outputs.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Extract version from tag
        id: version
        run: |
          VERSION=${GITHUB_REF#refs/tags/}
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "Building release: ${VERSION}"

      - name: Lint
        run: pnpm nx run-many -t lint --skip-nx-cache

      - name: Type check
        run: pnpm nx run-many -t typecheck --skip-nx-cache

      - name: Test
        run: pnpm nx run-many -t test --skip-nx-cache

      - name: Build API
        run: NODE_ENV=production pnpm nx build @org/api --configuration=production

      - name: Build Web
        run: NODE_ENV=production pnpm nx build @org/web --configuration=production

      - name: Create deployment package
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          DEPLOY_DIR="ansa-mes-${VERSION}"
          DIST_ROOT="dist-deployment"

          echo "Creating deployment package for release ${VERSION}..."
          mkdir -p ${DIST_ROOT}/${DEPLOY_DIR}

          # Copy API build
          mkdir -p ${DIST_ROOT}/${DEPLOY_DIR}/api
          cp -r apps/api/dist/* ${DIST_ROOT}/${DEPLOY_DIR}/api/

          # Copy Web build
          mkdir -p ${DIST_ROOT}/${DEPLOY_DIR}/web
          cp -r apps/web/dist/* ${DIST_ROOT}/${DEPLOY_DIR}/web/

          # Copy deployment scripts
          mkdir -p ${DIST_ROOT}/${DEPLOY_DIR}/scripts
          cp deployment/*.sh ${DIST_ROOT}/${DEPLOY_DIR}/scripts/
          chmod +x ${DIST_ROOT}/${DEPLOY_DIR}/scripts/*.sh

          # Copy nginx config
          mkdir -p ${DIST_ROOT}/${DEPLOY_DIR}/nginx
          cp deployment/nginx.conf ${DIST_ROOT}/${DEPLOY_DIR}/nginx/

          # Copy config template
          mkdir -p ${DIST_ROOT}/${DEPLOY_DIR}/config
          cp deployment/.env.template ${DIST_ROOT}/${DEPLOY_DIR}/config/.env.example

          # Copy documentation
          cp deployment/README.md ${DIST_ROOT}/${DEPLOY_DIR}/
          cp deployment/QUICK-START.md ${DIST_ROOT}/${DEPLOY_DIR}/
          cp deployment/CHANGELOG.md ${DIST_ROOT}/${DEPLOY_DIR}/

          # Create version file
          echo "${VERSION}" > ${DIST_ROOT}/${DEPLOY_DIR}/VERSION

          # Create tarball
          cd ${DIST_ROOT}
          tar -czf ${DEPLOY_DIR}.tar.gz ${DEPLOY_DIR}
          cd ..

          echo "Package created: ${DIST_ROOT}/${DEPLOY_DIR}.tar.gz"
          ls -lh ${DIST_ROOT}/${DEPLOY_DIR}.tar.gz

      - name: Generate release notes
        id: release_notes
        run: |
          VERSION="${{ steps.version.outputs.version }}"

          # Extract changelog section for this version
          if grep -q "## \[${VERSION}\]" deployment/CHANGELOG.md; then
            NOTES=$(sed -n "/## \[${VERSION}\]/,/## \[/p" deployment/CHANGELOG.md | sed '$d')
          else
            NOTES="Release ${VERSION}"
          fi

          # Save to file (multi-line handling)
          {
            echo "RELEASE_NOTES<<EOF"
            echo "$NOTES"
            echo ""
            echo "## Installation"
            echo ""
            echo "1. Download \`ansa-mes-${VERSION}.tar.gz\` from the assets below"
            echo "2. Transfer to your server and extract:"
            echo "   \`\`\`bash"
            echo "   tar -xzf ansa-mes-${VERSION}.tar.gz"
            echo "   cd ansa-mes-${VERSION}"
            echo "   \`\`\`"
            echo "3. Run the installer:"
            echo "   \`\`\`bash"
            echo "   sudo ./scripts/install.sh"
            echo "   \`\`\`"
            echo "4. See README.md in the package for complete installation instructions"
            echo ""
            echo "## Package Contents"
            echo ""
            echo "- NestJS API (compiled and optimized)"
            echo "- React Web UI (built and minified)"
            echo "- Deployment scripts (install, start, stop, status)"
            echo "- Nginx reverse proxy configuration"
            echo "- Complete documentation"
            echo "EOF"
          } >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          name: Ansa MES ${{ steps.version.outputs.version }}
          body: ${{ steps.release_notes.outputs.RELEASE_NOTES }}
          files: |
            dist-deployment/ansa-mes-${{ steps.version.outputs.version }}.tar.gz
          draft: false
          prerelease: false
          generate_release_notes: false

      - name: Upload artifact (backup)
        uses: actions/upload-artifact@v4
        with:
          name: ansa-mes-${{ steps.version.outputs.version }}
          path: dist-deployment/ansa-mes-${{ steps.version.outputs.version }}.tar.gz
          retention-days: 365
